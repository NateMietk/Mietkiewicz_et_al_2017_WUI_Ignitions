---
title: "R Notebook"
output:
  html_document:
    code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
library(tidyverse)
library(Hmisc)
library(kableExtra)

fpa_wui_df <- read_rds('fpa_wui_df.rds')
fpa_bae_wui_df <- read_rds('fpa_bae_wui_df.rds')
wui_209_df <- read_rds('wui_209_df.rds')
classify_fire_size_sml <-  function(x) {
  # break out fires into small, med, large
  # input:
  #   - x: vector of fire sizes
  # output:
  #   - y: vector (same length) of classified fire sizes ----- Km2
  ifelse(x < 4, "Small",
         ifelse(x >= 4 & x < 500, "Large",
                ifelse(x > 500, "Very Large")))
}
```

The purpose of this notebook is to generate all statistics used in the main body of the manuscript.  

# Abstract

#### How many fires were started by people in the WUI
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_wui_df)) %>%
  group_by(fpa_id, class_coarse, ignition) %>%
  summarise() %>% ungroup() %>%
  group_by(class_coarse, ignition) %>%
  count() %>% ungroup() %>%
  filter(class_coarse == 'WUI') %>%
  mutate(percent = n/sum(n)*100) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### Average WUI burned by humans each year
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_bae_wui_df)) %>%
  group_by(discovery_year, class_coarse, ignition) %>%
  summarise(sum_burned_area = sum(wui_area_km2, na.rm = TRUE),
            total_coarse_class_area = first(total_coarse_class_area)) %>%
  mutate(pct_yrly_burn = (sum_burned_area/total_coarse_class_area)*100) %>%
  group_by(class_coarse, ignition) %>%
  filter(class_coarse == 'WUI') %>%
  do(data.frame(rbind(smean.cl.boot(.$pct_yrly_burn, B = 10000)))) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### The total costs from human started wildfires in the WUI
```{r eval=TRUE}
as.data.frame(wui_209_df) %>%
  filter(class == 'WUI') %>%
  group_by(cause) %>%
  summarise(costs = sum(costs)) %>%
  mutate(percent = costs/sum(costs)*100) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### The total number of residential and structures threatened by human started wildfires in the WUI
```{r eval=TRUE}
```

#### Total suppression costs regardless of class
```{r eval=TRUE}
as.data.frame(wui_209_df) %>%
  group_by(cause) %>%
  summarise(costs = sum(costs)) %>%
  mutate(percent = costs/sum(costs)*100) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### How many fires occurred in the WUI from 1992-2015?
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(class) %>%
  count() %>%
  ungroup() %>%
  mutate(percent = n/sum(n)*100) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```

# Results
#### How much did the WUI burn
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_bae_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(class) %>%
  summarise(sum_burned_area = sum(wui_area_km2, na.rm = TRUE),
            total_class_area = first(total_class_area)) %>%
  mutate(pct_burn = (sum_burned_area/total_class_area)*100) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### Average total yearly burned area (km2) across the CONUS
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_bae_wui_df)) %>%
  group_by(discovery_year) %>%
  summarise(sum_burned_area = sum(wui_area_km2, na.rm = TRUE)) %>%
  group_by() %>%
  do(data.frame(rbind(smean.cl.boot(.$sum_burned_area, B = 10000)))) %>%
  mutate(total_burn_per_year = round(Mean, 4),
         lower_95_ci = round(Lower, 4),
         upper_95_ci = round(Upper, 4)) %>%
  dplyr::select(-Mean, -Lower, -Upper)  %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### Average class burned by each year
```{r eval=TRUE}
df1 <- as_tibble(as.data.frame(fpa_bae_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(discovery_year, class) %>%
  summarise(sum_burned_area = sum(wui_area_km2, na.rm = TRUE),
            total_class_area = first(total_class_area)) %>%
  mutate(pct_yrly_burn = (sum_burned_area/total_class_area)*100) %>%
  group_by(class) %>%
  do(data.frame(rbind(smean.cl.boot(.$pct_yrly_burn, B = 10000)))) %>%
  mutate(avg_pct_burn_per_year = round(Mean, 4),
         lower_95_ci = round(Lower, 4),
         upper_95_ci = round(Upper, 4)) %>%
  dplyr::select(-Mean, -Lower, -Upper)
df1
```
#### Average class burned by each year
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_bae_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(discovery_year, class) %>%
  summarise(sum_burned_area = sum(wui_area_km2, na.rm = TRUE),
            total_class_area = first(total_class_area)) %>%
  mutate(pct_yrly_burn = (sum_burned_area/total_class_area)*100) %>%
  group_by(class) %>%
  summarise(total_burned = sum(sum_burned_area),
            avg_burned_per_year = mean(sum_burned_area),
            total_pct_burn_per_year = sum(pct_yrly_burn)) %>%
  mutate(pct_burn_from_total = (total_burned/sum(total_burned))*100) %>%
  left_join(., df1, by = 'class') %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### Average wildfire size in each class - fine classes
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(class) %>%
  do(data.frame(rbind(smean.cl.boot(.$fire_size_km2, B = 10000)))) %>%
  mutate(avg_fire_size_km2 = round(Mean, 4)*100,
         lower_95_ci = round(Lower, 4)*100,
         upper_95_ci = round(Upper, 4)*100) %>%
  dplyr::select(-Mean, -Lower, -Upper)  %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### Average wildfire size in each class - coarse classes
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(class_coarse) %>%
  do(data.frame(rbind(smean.cl.boot(.$fire_size_km2, B = 10000)))) %>%
  mutate(avg_fire_size_km2 = round(Mean, 4)*100,
         lower_95_ci = round(Lower, 4)*100,
         upper_95_ci = round(Upper, 4)*100) %>%
  dplyr::select(-Mean, -Lower, -Upper)  %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
#### Length of the wildfire season in each class
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(class) %>%
  summarise(fire_season_length = IQR(discovery_doy)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```
# Results - Human-related ignitions contributed substantially to U.S. wildfire costs

# Supplemental Tables
#### Table 1 
```{r eval=TRUE}
as_tibble(as.data.frame(fpa_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(class) %>%
  summarise(fire_frequency = n(),
            wildfire_burned_area = sum(fire_size_km2),
            fire_season_length = IQR(discovery_doy)) %>%
  mutate(pct_frequency = fire_frequency/sum(fire_frequency)*100,
         pct_burned_area = wildfire_burned_area/sum(wildfire_burned_area)*100) %>%
  mutate_if(is.numeric, funs(round(., 2))) %>%
  rownames_to_column()  %>%
  gather(var, value, -rowname) %>% 
  spread(rowname, value) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)

as_tibble(as.data.frame(fpa_bae_wui_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(class) %>%
  summarise(class_burned_area = sum(wui_area_km2),
            total_class_area = first(total_class_area)) %>%
  mutate(pct_class_burned_area = (class_burned_area/total_class_area)*100) %>%
  mutate_if(is.numeric, funs(round(., 2))) %>%
  rownames_to_column()  %>%
  gather(var, value, -rowname) %>% 
  spread(rowname, value) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)

as_tibble(as.data.frame(wui_209_df)) %>%
  filter(!(class %in% c("High Urban", "Med Urban", "Low Urban", 'Other'))) %>%
  transform(class = factor(class, levels=c('Intermix WUI', 'Interface WUI', 'VLD', 'Wildlands'))) %>%
  group_by(class) %>%
  summarise(costs = sum(costs)) %>%
  mutate(pct_costs = (costs/sum(costs))*100) %>%
  mutate_if(is.numeric, funs(round(., 2))) %>%
  rownames_to_column()  %>%
  gather(var, value, -rowname) %>% 
  spread(rowname, value) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = 'left', font_size = 10)
```






